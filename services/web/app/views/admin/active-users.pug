extends ../layout-marketing

block append foot-scripts
	script(nonce=scriptNonce).
		document.addEventListener('DOMContentLoaded', function() {
			console.log('[Admin Active Users] Page loaded, initializing...');
			
			// CSRF token from server
			const csrfToken = !{JSON.stringify(csrfToken)};
			
			let currentUserId = null;
			let currentUserEmail = null;
			
			// this entire file is an absolute mess, but it works so I'm not going to fix it
			// since bootstrap keeps acting up using vanilla JS
			function showModal(modalId) {
				const modal = document.getElementById(modalId);
				if (modal) {
					modal.style.display = 'block';
				}
			}
			
			function hideModal(modalId) {
				const modal = document.getElementById(modalId);
				if (modal) {
					modal.style.display = 'none';
				}
			}
			
			window.onclick = function(event) {
				if (event.target.id === 'resetUrlModal') {
					hideModal('resetUrlModal');
				}
				if (event.target.id === 'changeEmailModal') {
					hideModal('changeEmailModal');
				}
				if (event.target.id === 'deleteUserModal') {
					hideModal('deleteUserModal');
				}
			}
			
			document.getElementById('close-reset-modal').addEventListener('click', () => hideModal('resetUrlModal'));
			document.getElementById('close-reset-modal-btn').addEventListener('click', () => hideModal('resetUrlModal'));
			document.getElementById('close-email-modal').addEventListener('click', () => hideModal('changeEmailModal'));
			document.getElementById('close-email-modal-btn').addEventListener('click', () => hideModal('changeEmailModal'));
			document.getElementById('close-delete-modal').addEventListener('click', () => hideModal('deleteUserModal'));
			document.getElementById('close-delete-modal-btn').addEventListener('click', () => hideModal('deleteUserModal'));
			
			console.log('[Admin Active Users] Vanilla JS modals initialized successfully');

			const resetButtons = document.querySelectorAll('.send-reset-btn');
			console.log('[Admin Active Users] Found ' + resetButtons.length + ' reset password buttons');
			
			resetButtons.forEach(btn => {
				btn.addEventListener('click', function() {
					console.log('[Admin Active Users] Reset password button clicked');
					const userId = this.dataset.userId;
					const userEmail = this.dataset.userEmail;
					
					const originalHTML = btn.innerHTML;
					btn.disabled = true;
					btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Generating...';
					
					fetch(`/admin/users/${userId}/password-reset`, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
							'X-CSRF-Token': csrfToken
						}
					})
					.then(res => {
						if (!res.ok) {
							throw new Error('HTTP ' + res.status + ': ' + res.statusText);
						}
						return res.json();
					})
					.then(data => {
						if (data.success && data.resetUrl) {
							console.log('[Admin Active Users] Reset URL generated, showing modal');
							// Show modal with reset URL
							document.getElementById('reset-user-email').textContent = userEmail;
							document.getElementById('reset-url-display').value = data.resetUrl;
							showModal('resetUrlModal');
						} else {
							alert('Error: ' + (data.error || 'Unknown error'));
						}
						btn.innerHTML = originalHTML;
						btn.disabled = false;
					})
					.catch(err => {
						console.error('[Admin Active Users] Reset password error:', err);
						alert('Failed to generate password reset link: ' + err.message);
						btn.innerHTML = originalHTML;
						btn.disabled = false;
					});
				});
			});

			// Copy reset URL to clipboard
			document.getElementById('copy-reset-url').addEventListener('click', function() {
				const textarea = document.getElementById('reset-url-display');
				textarea.select();
				textarea.setSelectionRange(0, 99999); // For mobile
				
				try {
					document.execCommand('copy');
					const originalHTML = this.innerHTML;
					this.innerHTML = '<i class="fa fa-check"></i> Copied!';
					this.classList.remove('btn-primary');
					this.classList.add('btn-success');
					
					setTimeout(() => {
						this.innerHTML = originalHTML;
						this.classList.remove('btn-success');
						this.classList.add('btn-primary');
					}, 2000);
				} catch (err) {
					alert('Failed to copy: ' + err.message);
				}
			});

			// Change Email
			const changeEmailButtons = document.querySelectorAll('.change-email-btn');
			console.log('[Admin Active Users] Found ' + changeEmailButtons.length + ' change email buttons');
			
			changeEmailButtons.forEach(btn => {
				btn.addEventListener('click', function() {
					console.log('[Admin Active Users] Change email button clicked');
					currentUserId = this.dataset.userId;
					currentUserEmail = this.dataset.userEmail;
					document.getElementById('current-email-display').textContent = currentUserEmail;
					document.getElementById('new-email').value = '';
					showModal('changeEmailModal');
				});
			});

			const confirmChangeEmailBtn = document.getElementById('confirm-change-email');
			if (confirmChangeEmailBtn) {
				confirmChangeEmailBtn.addEventListener('click', function() {
					console.log('[Admin Active Users] Confirm change email clicked');
					const newEmail = document.getElementById('new-email').value.trim();
					
					if (!newEmail || !newEmail.includes('@')) {
						alert('Please enter a valid email address');
						return;
					}
					
					const originalHTML = this.innerHTML;
					this.disabled = true;
					this.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Changing...';
					
					fetch(`/admin/users/${currentUserId}/change-email`, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
							'X-CSRF-Token': csrfToken
						},
						body: JSON.stringify({ newEmail })
					})
					.then(res => {
						if (!res.ok) {
							throw new Error('HTTP ' + res.status + ': ' + res.statusText);
						}
						return res.json();
					})
					.then(data => {
						if (data.success) {
							console.log('[Admin Active Users] Email changed successfully');
							alert('Email changed successfully!');
							hideModal('changeEmailModal');
							location.reload();
						} else {
							alert('Error: ' + (data.error || 'Unknown error'));
							this.disabled = false;
							this.innerHTML = originalHTML;
						}
					})
					.catch(err => {
						console.error('[Admin Active Users] Change email error:', err);
						alert('Failed to change email: ' + err.message);
						this.disabled = false;
						this.innerHTML = originalHTML;
					});
				});
			} else {
				console.error('[Admin Active Users] Confirm change email button not found');
			}

			// Delete User
			const deleteUserButtons = document.querySelectorAll('.delete-user-btn');
			console.log('[Admin Active Users] Found ' + deleteUserButtons.length + ' delete user buttons');
			
			deleteUserButtons.forEach(btn => {
				btn.addEventListener('click', function() {
					console.log('[Admin Active Users] Delete user button clicked');
					currentUserId = this.dataset.userId;
					currentUserEmail = this.dataset.userEmail;
					document.getElementById('delete-user-email').textContent = currentUserEmail;
					showModal('deleteUserModal');
				});
			});

			const confirmDeleteBtn = document.getElementById('confirm-delete-user');
			if (confirmDeleteBtn) {
				confirmDeleteBtn.addEventListener('click', function() {
					console.log('[Admin Active Users] Confirm delete clicked');
					const originalHTML = this.innerHTML;
					this.disabled = true;
					this.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Deleting...';
					
					fetch(`/admin/users/${currentUserId}`, {
						method: 'DELETE',
						headers: {
							'Content-Type': 'application/json',
							'X-CSRF-Token': csrfToken
						}
					})
					.then(res => {
						if (!res.ok) {
							throw new Error('HTTP ' + res.status + ': ' + res.statusText);
						}
						return res.json();
					})
					.then(data => {
						if (data.success) {
							console.log('[Admin Active Users] User deleted successfully');
							alert('User deleted successfully!');
							hideModal('deleteUserModal');
							location.reload();
						} else {
							alert('Error: ' + (data.error || 'Unknown error'));
							this.disabled = false;
							this.innerHTML = originalHTML;
						}
					})
					.catch(err => {
						console.error('[Admin Active Users] Delete user error:', err);
						alert('Failed to delete user: ' + err.message);
						this.disabled = false;
						this.innerHTML = originalHTML;
					});
				});
			} else {
				console.error('[Admin Active Users] Confirm delete button not found');
			}
			
			console.log('[Admin Active Users] All event listeners attached successfully');
		});

block content
	.content.content-alt
		.container
			.row
				.col-md-12
					.card
						.card-body
							h1 Editing Users Monitoring
							
							.alert.alert-info(style='margin-top: 20px;')
								strong Total Users Currently Editing: #{onlineCount}
								p.mb-0(style='margin-top: 8px;') This shows users who are currently editing a project in the editor.
							
							.d-flex.justify-content-between.align-items-center(style='margin: 20px 0;')
								p.text-muted Showing all registered users (users currently editing are marked with a green badge)
								a.btn.btn-primary(href='/admin/users' onclick='window.location.reload(); return false;')
									i.fa.fa-refresh(style='margin-right: 5px;')
									| Refresh
							
							if users && users.length > 0
								.table-responsive
									table.table.table-striped.table-hover#users-table
										thead
											tr
												th(style='width: 50px;') Status
												th Email
												th Name
												th Current Project
												th Storage Used
												th(style='width: 280px;') Actions
										tbody
											each user in users
												tr(data-user-id=user._id)
													td
														- const isEditing = user.isOnline === true || user.isOnline === 'true' || String(user.isOnline) === 'true'
														- const statusText = isEditing ? 'Currently Editing' : 'Not Editing'
														- const statusClass = isEditing ? 'bg-success' : 'bg-secondary'
														if isEditing
															span.badge(class=statusClass title=statusText data-status='editing') ●
														else
															span.badge(class=statusClass title=statusText data-status='not-editing') ●
													td= user.email
													td= (user.first_name || '') + ' ' + (user.last_name || '')
													td
														if user.currentProject
															a(href=`/project/${user.currentProject.id}` target='_blank')= user.currentProject.name
														else
															span.text-muted -
													td
														- const kb = (user.storageUsed / 1024).toFixed(2)
														- const mb = (user.storageUsed / (1024 * 1024)).toFixed(2)
														if user.storageUsed > 1048576
															= mb + ' MB'
														else if user.storageUsed > 1024
															= kb + ' KB'
														else
															= user.storageUsed + ' B'
													td
														.d-flex.gap-1.flex-wrap
															button.btn.btn-sm.btn-warning.send-reset-btn(
																type='button'
																data-user-id=user._id
																data-user-email=user.email
																title='Generate Password Reset Link'
															)
																i.fa.fa-key(style='margin-right: 4px;')
																| Reset
															button.btn.btn-sm.btn-info.change-email-btn(
																type='button'
																data-user-id=user._id
																data-user-email=user.email
																title='Change User Email'
															)
																i.fa.fa-envelope(style='margin-right: 4px;')
																| Email
															button.btn.btn-sm.btn-danger.delete-user-btn(
																type='button'
																data-user-id=user._id
																data-user-email=user.email
																title='Delete User and All Projects'
															)
																i.fa.fa-trash(style='margin-right: 4px;')
																| Delete
							else
								.alert.alert-warning No users found in the database.
							
							.text-muted(style='margin-top: 20px; font-size: 0.9em;')
								p 
									strong Note: 
									| Online status is determined by active sessions. 
									| Current project information shows users actively editing projects.
									| Storage usage is calculated from project document sizes.
									br
									strong Warning: 
									| Admin actions (password reset, email change, delete) are powerful operations. Use with caution!

	//- Modal for password reset URL display (vanilla JS, no Bootstrap)
	#resetUrlModal(style='display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);')
		div(style='background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);')
			div(style='display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;')
				h5(style='margin: 0;') Password Reset Link
				button#close-reset-modal(style='background: none; border: none; font-size: 24px; cursor: pointer; color: #aaa;') ×
			div
				p Send this link to: 
					strong#reset-user-email
				div(style='margin: 15px 0;')
					label(style='display: block; margin-bottom: 5px;') Reset URL (expires in 24 hours):
					textarea#reset-url-display(rows='4' readonly style='width: 100%; font-family: monospace; font-size: 12px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;')
			div(style='display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;')
				button#copy-reset-url(style='padding: 8px 16px; background: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer;')
					i.fa.fa-copy(style='margin-right: 5px;')
					| Copy to Clipboard
				button#close-reset-modal-btn(style='padding: 8px 16px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;') Close

	//- Modal for change email (vanilla JS, no Bootstrap)
	#changeEmailModal(style='display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);')
		div(style='background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);')
			div(style='display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;')
				h5(style='margin: 0;') Change User Email
				button#close-email-modal(style='background: none; border: none; font-size: 24px; cursor: pointer; color: #aaa;') ×
			div
				p Current email: 
					strong#current-email-display
				div(style='margin: 15px 0;')
					label(for='new-email' style='display: block; margin-bottom: 5px;') New Email Address
					input#new-email(type='email' placeholder='user@example.com' required style='width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;')
			div(style='display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;')
				button#close-email-modal-btn(style='padding: 8px 16px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;') Cancel
				button#confirm-change-email(style='padding: 8px 16px; background: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer;') Change Email

	//- Modal for delete confirmation (vanilla JS, no Bootstrap)
	#deleteUserModal(style='display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);')
		div(style='background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);')
			div(style='display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background-color: #dc3545; color: white; padding: 10px; margin: -20px -20px 15px -20px; border-radius: 8px 8px 0 0;')
				h5(style='margin: 0;') Delete User
				button#close-delete-modal(style='background: none; border: none; font-size: 24px; cursor: pointer; color: white;') ×
			div
				p(style='color: #dc3545;')
					strong WARNING: This action cannot be undone!
				p You are about to delete user: 
					strong#delete-user-email
				p This will:
				ul
					li Delete all user projects
					li Remove the user account
					li Send a deletion email to the user
			div(style='display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;')
				button#close-delete-modal-btn(style='padding: 8px 16px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;') Cancel
				button#confirm-delete-user(style='padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;') Delete User

