include ./_mixins/foot_scripts

doctype html
html(
	lang=currentLngCode || 'en'
	class=fixedSizeDocument ? 'fixed-size-document' : undefined
)
	- metadata = metadata || {}
	- let isWebsiteRedesign = false
	- let isApplicationPage = false
	- let enableIeeeBranding = true

	block entrypointVar

	block isApplicationPageVar

	block vars

	head
		include ./_metadata.pug

		//- Stylesheet
		link(rel='stylesheet' href=buildCssPath() id='main-stylesheet')
		block css
			each file in entrypointStyles(entrypoint)
				link(rel='stylesheet' href=file)

		block _headLinks

		if typeof suppressRelAlternateLinks == 'undefined'
			if settings.i18n.subdomainLang
				each subdomainDetails in settings.i18n.subdomainLang
					if !subdomainDetails.hide
						link(
							rel='alternate'
							href=subdomainDetails.url + currentUrl
							hreflang=subdomainDetails.lngCode
						)

		if entrypoint !== 'marketing'
			link(
				rel='preload'
				href=buildJsPath(currentLngCode + '-json.js')
				as='script'
				nonce=scriptNonce
			)

		//- Scripts
		if typeof suppressAnalytics == 'undefined'
			include _google_analytics

		block meta
			meta(name='ol-csrfToken' content=csrfToken)
			//- Configure dynamically loaded assets (via webpack) to be downloaded from CDN
			//- See: https://webpack.js.org/guides/public-path/#on-the-fly
			meta(name='ol-baseAssetPath' content=buildBaseAssetPath())
			meta(name='ol-mathJaxPath' content=mathJaxPath)
			meta(name='ol-dictionariesRoot' content=dictionariesRoot)

			meta(name='ol-usersEmail' content=getUserEmail())
			meta(name='ol-ab' data-type='json' content={})
			meta(name='ol-user_id' content=getLoggedInUserId())
			//- Internationalisation settings
			meta(
				name='ol-i18n'
				data-type='json'
				content={
					currentLangCode: currentLngCode,
				}
			)
			//- Expose some settings globally to the frontend
			meta(name='ol-ExposedSettings' data-type='json' content=ExposedSettings)
			meta(
				name='ol-splitTestVariants'
				data-type='json'
				content=splitTestVariants || {}
			)
			meta(name='ol-splitTestInfo' data-type='json' content=splitTestInfo || {})

			if typeof settings.algolia != 'undefined'
				meta(
					name='ol-algolia'
					data-type='json'
					content={
						appId: settings.algolia.app_id,
						apiKey: settings.algolia.read_only_api_key,
						indexes: settings.algolia.indexes,
					}
				)

			meta(
				name='ol-isManagedAccount'
				data-type='boolean'
				content=isManagedAccount
			)
			each restriction in userRestrictions || []
				meta(name='ol-cannot-' + restriction data-type='boolean' content)

		block head-scripts
		
		//- CRITICAL: Apply theme IMMEDIATELY before any rendering to prevent flash
		script(nonce=scriptNonce).
			(function() {
				function getCookie(name) {
					const value = '; ' + document.cookie;
					const parts = value.split('; ' + name + '=');
					if (parts.length === 2) return parts.pop().split(';').shift();
					return null;
				}
				
				const theme = getCookie('overleaf_theme');
				if (theme === 'dark') {
					document.documentElement.classList.add('dark-theme-marketing-preload');
				}
			})();

	-
		// Check cookie for theme preference
		function getThemeFromCookie() {
			if (typeof req !== 'undefined' && req.cookies && req.cookies.overleaf_theme) {
				return req.cookies.overleaf_theme;
			}
			// Default to light (user can toggle to dark)
			return 'light';
		}
		const cookieTheme = getThemeFromCookie();
		const isDarkTheme = (cookieTheme === 'dark');
	body(
		class={
			'thin-footer': showThinFooter,
			'website-redesign': isWebsiteRedesign === true || websiteRedesignOverride,
			'application-page': isApplicationPage,
			'dark-theme-marketing': isDarkTheme,
		}
		data-theme='default'
	)
		if settings.recaptcha && settings.recaptcha.siteKeyV3
			script(
				type='text/javascript'
				nonce=scriptNonce
				src='https://www.recaptcha.net/recaptcha/api.js?render=' + settings.recaptcha.siteKeyV3
				defer=deferScripts
			)

		if typeof suppressSkipToContent == 'undefined'
			a(class='skip-to-content' href='#main-content') #{translate('skip_to_content')}

		block body

		if settings.devToolbar.enabled
			#dev-toolbar

	block foot-scripts
		+foot-scripts
		
		//- Universal theme toggle script (works on ALL pages)
		script(type='text/javascript' nonce=scriptNonce).
			(function() {
				function getCookie(name) {
					const value = '; ' + document.cookie;
					const parts = value.split('; ' + name + '=');
					if (parts.length === 2) return parts.pop().split(';').shift();
					return null;
				}
				
				function setCookie(name, value, days) {
					const date = new Date();
					date.setTime(date.getTime() + (days || 365) * 24 * 60 * 60 * 1000);
					const expires = 'expires=' + date.toUTCString();
					document.cookie = name + '=' + value + ';' + expires + ';path=/;SameSite=Lax';
				}
				
				function getCurrentTheme() {
					return document.body.classList.contains('dark-theme-marketing') ? 'dark' : 'light';
				}
				
				function applyTheme(theme) {
					if (theme === 'dark') {
						document.body.classList.add('dark-theme-marketing');
						document.documentElement.classList.add('dark-theme-marketing-preload');
					} else {
						document.body.classList.remove('dark-theme-marketing');
						document.documentElement.classList.remove('dark-theme-marketing-preload');
					}
				}
				
				function updateToggleIcon(theme) {
					const icon = document.getElementById('theme-icon');
					if (icon) {
						icon.textContent = theme === 'dark' ? 'light_mode' : 'dark_mode';
					}
				}
				
				function initThemeToggle() {
					// Get the saved theme from cookie
					const savedTheme = getCookie('overleaf_theme');
					
					// Apply theme from cookie (overrides server-rendered class if needed)
					if (savedTheme) {
						applyTheme(savedTheme);
					}
					
					// Determine current theme (from body class or cookie)
					const currentTheme = getCurrentTheme();
					
					// Update toggle button icon
					updateToggleIcon(currentTheme);
					
					// Set up click handler for toggle button
					const toggleBtn = document.getElementById('theme-toggle-btn');
					if (toggleBtn) {
						toggleBtn.addEventListener('click', function() {
							const currentTheme = getCurrentTheme();
							const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
							applyTheme(newTheme);
							setCookie('overleaf_theme', newTheme);
							updateToggleIcon(newTheme);
						});
					}
				}
				
				// Make theme toggle globally available
				window.initThemeToggle = initThemeToggle;
				
				// Run on DOMContentLoaded to ensure toggle button exists
				if (document.readyState === 'loading') {
					document.addEventListener('DOMContentLoaded', initThemeToggle);
				} else {
					initThemeToggle();
				}
			})();

	include _customer_io
